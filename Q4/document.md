# 設問4

## 要求定義

pingがタイムアウトした場合を故障とみなし最初にタイムアウトしたときから次にpingの応答が返るまでを故障期間とする。
監視ログファイルを読み込み、故障状態のサーバアドレスとそのサーバの故障期間を出力する.
ただし, 連続N回未満のタイムアウトでは故障とみなさないようにする. 
さらに, subnet単位でも故障期間検出を行い同様に出力する. 
また, m回の平均応答時間がtミリ秒を超える場合はサーバが過負荷状態であるとみなす.
過負荷状態のサーバ期間も出力できるようにする. 
ただし, 直近m回の中にタイムアウトが存在する場合, そのタイムアウトは平均の計算から除外しm-1回の平均で判断する
N, m, tはパラメータとして外部から与えられる. 

## 外部設計
 - 入力  
    ログが書き込まれたCSVファイル名と
    故障とみなす連続タイムアウト回数N , 
    及び, 過負荷判断のための平均計算回数mと閾値時間t
    を入力とする.   
    ただし, パラメータが明示的に示されない場合
    N=1, m=1, t=4294967295とする. 
    する.
    ```
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
        :
        :
    ```
    ただし, CSVファイルは一行あたりの要素を3つのみとし, それ以外の行は無視する. 

    - 確認日時  
    確認日時はYYYYMMDDhhmmssの形式とする.
    ただし, YYYY=西暦(4桁の半角数字), MM=月(2桁の半角数字), 
    DD=日(2桁の半角数字), hh=時(2桁の半角数字), mm=分(2桁の半角数字), ss=秒(2桁の半角数字)とする. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

    - サーバアドレス  
    サーバアドレスはネットワークプレフックス長付きのIPv4アドレスとする.   

    - 応答結果  
    応答結果はpingの応答時間をミリ秒単位で記載される.  
    ただしタイムアウトの場合は"-"のみが記載される. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

 - 出力  
    以下のフォーマットで故障期間を標準出力に表示する. 

    ```
    IP		故障はじめ			故障終わり			期間
    <サーバアドレス1>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    <サーバアドレス2>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    IP		高負荷はじめ			高負荷終わり			期間
    <サーバアドレス1>
        <過負荷始まり> <過負荷終わり> <期間>
        <過負荷始まり> <過負荷終わり> <期間>
            :
    <サーバアドレス2>
        <過負荷始まり> <過負荷終わり> <期間>
        <過負荷始まり> <過負荷終わり> <期間>
            :
    NetAddress 故障はじめ			故障終わり			期間
    <ネットワークアドレス1>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    <ネットワークアドレス2>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :

    ```
    ただし, 故障期間や過負荷期間の無いサーバアドレスはその直前に表示しない. 

    故障期間の始まり, 終わりはそれぞれ 
    "YYYY年MM月DD日hh時mm分ss秒" の形式とする. 
    また 故障期間は"d日h時間m分s秒 間"とする. 
    ただし, d > 0, h ∈ [1, 23], m ∈ [1, 59], s ∈ [1, 59] の整数とし, 
    それぞれが0の時はその数値と後続の単位の表示を行わない. 

    最新の応答結果がタイムアウトの場合は, <故障終わり>を"継続中"とし, 
    故障期間を表示しない. 
    また同様に, 最新のping平均によって過負荷が判定された場合, 
    <過負荷終わり>を"継続中"とし, 故障期間を表示しない. 

 - 環境と実行方法  
    OS : Ubuntu18.04 LTS, python3.8.5 で動作を確認  
    `$python3 q3.py <CSVファイル名>`
    或いは
    `$python3 q3.py <CSVファイル名> --N <N> --t <t> --m <m>`

##  内部設計

### データフロー

入力されたデータは次のような流れで処理をする.  

1. コマンドライン引数を解析し, 入力ファイル名を決定する.  
2. 決定された入力ファイルを読み込み以下の形式で集計する.  
    ここで, "()"はタプルを, "[]"はリストを意味する. 
    ```
    [
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]),
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
                :
    ]
    ```
3. 2で集計されたデータ形式をパラメータmを参照しながら下記の形式で示された構造に集計し直す.  
    ここで, "()"はタプルを, "[]"はリスト, "{}"は連想配列を意味する. 
    ```
    {
        <サーバアドレス1> : [(<確認datetime 1-1>, <ping値>, <直近m回ping平均>), (<確認datetime 1-2>, <ping値>, <直近m回ping平均>) ... ], 
        <サーバアドレス2> : [(<確認datetime 2-1>, <ping値>, <直近m回ping平均>), (<確認datetime 2-2>, <ping値>, <直近m回ping平均>) ... ], 
            .
            .
            .
    }
    ```
    <確認datetime n-k> は `datetime.datetime`クラスのインスタンスとする. 
    <ping値>はタイムアウト時はNoneそれ以外ではpingの応答時間の整数値とする.  
    ただし, 任意のn, k < l ∈ 自然数において, 
    datetime n-k < datetime n-l となるようにソートする. 

4. 3で得られた連想配列とパラメータNから故障状態を求め, サーバアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <サーバアドレス1> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
        <サーバアドレス2> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
    }
    ```
    <故障期間の始まり>, <故障期間の終わり>, <故障期間>はそれぞれ, 外部設計仕様に従う. 

5. 4で求められた故障状態を表示する.  
    外部設計仕様に従い表示する


6. 3で得られた連想配列とパラメータNから過負荷期間を求め, サーバアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <サーバアドレス1> : [
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
        ],
        <サーバアドレス2> : [
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
        ],
    }
    ```
    <過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>はそれぞれ, 外部設計仕様に従う. 

7. 6で求められた過負荷状態を表示する.  
    外部設計仕様に従い表示する

8. 3で得られた連想配列で同様のネットワークアドレスを持つサーバアドレスを統合し, 新たな連想配列とする
    ```
    {
        <ネットワークアドレス1> : [(<確認datetime 1-1>, <ping値>, <直近m回ping平均>), (<確認datetime 1-2>, <ping値>, <直近m回ping平均>) ... ], 
        <ネットワークアドレス2> : [(<確認datetime 2-1>, <ping値>, <直近m回ping平均>), (<確認datetime 2-2>, <ping値>, <直近m回ping平均>) ... ], 
            .
            .
            .
    }

    ```
9. 8で得られた連想配列とパラメータNから故障状態を求め, ネットワークアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <ネットワークアドレス1> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
        <ネットワークアドレス2> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
    }
    ```
    <故障期間の始まり>, <故障期間の終わり>, <故障期間>はそれぞれ, 外部設計仕様に従う. 
    ** ※ キーがサーバアドレスからネットワークアドレスに変わっただけで, 4と同じ処理で実装ができる. **


10. 8で求められた故障期間を表示する.  
    外部設計仕様に従い表示する


## テスト

### 設問1に対するテスト 
ここではサーバ毎の故障期間の表示部分のみを確認し,  過負荷状態やネットワーク毎の故障期間は確認しない.  
実行は`python3 q4.py <ファイル名>` とする.  
詳細はQ1/document.mdを参照.  
同様の結果を確認しているため, ここでは出力を示さない. 
- [x] test1-0.csv  
- [x] test1-1.csv  
- [x] test1-2.csv  
- [x] test1-3.csv  
- [x] test1-4.csv  
- [x] test1-5.csv  

### 設問2に対するテスト  
ここではサーバ毎の故障期間の表示部分のみを確認し, 過負荷状態やネットワーク毎の故障期間は確認しない.   
実行は`python3 q4.py <ファイル名> --N <N>` とする.  
詳細はQ2/document.mdを参照.  
同様の結果を確認しているため, ここでは出力を示さない. 
- [x] N=2の時  
- [x] N=3の時  
- [x] N=4の時  

### 設問3に対するテスト
ここではサーバ毎の過負荷期間の表示部分のみ確認し, ほかは確認しない. 
詳細はQ3/document.mdを参照.  
同様の結果を確認しているため, ここでは出力を示さない. 
- [x] test3-0.csv  
- [x] test3-1.csv  
- [x] test3-2.csv  

### 設問4に対するテスト
ここではネットワークアドレス毎の故障期間の表示部分のみ確認し, ほかは確認しない. 
- [x] test4-0.csv  
    一つのサブネットを持つケース. 
    N<=2のとき故障期間が検出されるが, N>=3だと検出されない. 
    - [x] N = 2  
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分26秒	継続中	
10.20.30.2/16
		2020年10月19日13時32分24秒	継続中	
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
10.20.0.0
		2020年10月19日13時31分26秒	2020年10月19日13時32分25秒	59秒間
		2020年10月19日13時32分26秒	2020年10月19日13時33分30秒	1分4秒間
```
    - [x] N = 3
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
```
- [x] test4-1.csv  
    一つのサブネットプレフィックスでネットワークアドレスがちがう場合  
    N = 1で, 20.系と10.系両方で, 故障が検出される.
    N = 2で, 20.系だけで, 故障が検出される.
    - [x] N=1
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分20秒	継続中	
20.20.30.2/16
		2020年10月19日13時31分24秒	継続中	
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
10.20.0.0
		2020年10月19日13時31分20秒	2020年10月19日13時31分25秒	5秒間
		2020年10月19日13時31分26秒	2020年10月19日13時32分25秒	59秒間
		2020年10月19日13時32分26秒	2020年10月19日13時33分30秒	1分4秒間
20.20.0.0
		2020年10月19日13時31分24秒	継続中	
```
    - [x] N=2
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分20秒	継続中	
20.20.30.2/16
		2020年10月19日13時31分24秒	継続中	
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
20.20.0.0
		2020年10月19日13時31分24秒	継続中	
```

- [x] test4-2.csv  
異なるプレフィックス長をもつネットワークアドレスがログに存在する場合. 
N = 1で, 2系統で, 故障が検出される.
N = 2で, 1系統のみで, 故障が検出される.
    - [x] N = 1
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分20秒	継続中	
10.20.30.2/12
		2020年10月19日13時31分24秒	継続中	
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
10.20.0.0
		2020年10月19日13時31分20秒	2020年10月19日13時31分25秒	5秒間
		2020年10月19日13時31分26秒	2020年10月19日13時32分25秒	59秒間
		2020年10月19日13時32分26秒	2020年10月19日13時33分30秒	1分4秒間
10.16.0.0
		2020年10月19日13時31分24秒	継続中	
```
    - [x] N = 2  
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分20秒	継続中	
10.20.30.2/12
		2020年10月19日13時31分24秒	継続中	
IP		過負荷はじめ			過負荷終わり			期間
NetAddress		故障はじめ			故障終わり			期間
10.16.0.0
		2020年10月19日13時31分24秒	継続中	
```
