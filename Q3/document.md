# 設問3

## 要求定義

pingがタイムアウトした場合を故障とみなし最初にタイムアウトしたときから次にpingの応答が返るまでを故障期間とする。
監視ログファイルを読み込み、故障状態のサーバアドレスとそのサーバの故障期間を出力する
ただし, 連続N回未満のタイムアウトでは故障とみなさないようにする. 
また, m回の平均応答時間がtミリ秒を超える場合はサーバが過負荷状態であるとみなす.
過負荷状態のサーバ期間も出力できるようにする. 
**ただし, 直近m回の中にタイムアウトが存在する場合, そのタイムアウトは平均の計算から除外しm-1回の平均で判断する**
N, m, tはパラメータとして外部から与えられる. 

## 外部設計
 - 入力  
    ログが書き込まれたCSVファイル名と
    故障とみなす連続タイムアウト回数N , 
    及び, 過負荷判断のための平均計算回数mと閾値時間t
    を入力とする.   
    ただし, パラメータが明示的に示されない場合
    N=1, m=1, t=4294967295とする. 
    する.
    ```
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
        :
        :
    ```
    ただし, CSVファイルは一行あたりの要素を3つのみとし, それ以外の行は無視する. 

    - 確認日時  
    確認日時はYYYYMMDDhhmmssの形式とする.
    ただし, YYYY=西暦(4桁の半角数字), MM=月(2桁の半角数字), 
    DD=日(2桁の半角数字), hh=時(2桁の半角数字), mm=分(2桁の半角数字), ss=秒(2桁の半角数字)とする. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

    - サーバアドレス  
    サーバアドレスはネットワークプレフックス長付きのIPv4アドレスとする.   

    - 応答結果  
    応答結果はpingの応答時間をミリ秒単位で記載される.  
    ただしタイムアウトの場合は"-"のみが記載される. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

 - 出力  
    以下のフォーマットで故障期間を標準出力に表示する. 

    ```
    IP		故障はじめ			故障終わり			期間
    <サーバアドレス1>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    <サーバアドレス2>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    IP		高負荷はじめ			高負荷終わり			期間
    <サーバアドレス1>
        <過負荷始まり> <過負荷終わり> <期間>
        <過負荷始まり> <過負荷終わり> <期間>
            :
    <サーバアドレス2>
        <過負荷始まり> <過負荷終わり> <期間>
        <過負荷始まり> <過負荷終わり> <期間>
            :

    ```
    ただし, 故障期間や過負荷期間の無いサーバアドレスはその直前に表示しない. 

    故障期間の始まり, 終わりはそれぞれ 
    "YYYY年MM月DD日hh時mm分ss秒" の形式とする. 
    また 故障期間は"d日h時間m分s秒 間"とする. 
    ただし, d > 0, h ∈ [1, 23], m ∈ [1, 59], s ∈ [1, 59] の整数とし, 
    それぞれが0の時はその数値と後続の単位の表示を行わない. 

    最新の応答結果がタイムアウトの場合は, <故障終わり>を"継続中"とし, 
    故障期間を表示しない. 
    また同様に, 最新のping平均によって過負荷が判定された場合, 
    <過負荷終わり>を"継続中"とし, 故障期間を表示しない. 

 - 環境と実行方法  
    OS : Ubuntu18.04 LTS, python3.8.5 で動作を確認  
    `$python3 q3.py <CSVファイル名>`
    或いは
    `$python3 q3.py <CSVファイル名> --N <N> --t <t> --m <m>`

##  内部設計

### データフロー

入力されたデータは次のような流れで処理をする.  

1. コマンドライン引数を解析し, 入力ファイル名を決定する.  
2. 決定された入力ファイルを読み込み以下の形式で集計する.  
    ここで, "()"はタプルを, "[]"はリストを意味する. 
    ```
    [
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]),
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
                :
    ]
    ```
3. 2で集計されたデータ形式をパラメータmを参照しながら下記の形式で示された構造に集計し直す.  
    ここで, "()"はタプルを, "[]"はリスト, "{}"は連想配列を意味する. 
    ```
    {
        <サーバアドレス1> : [(<確認datetime 1-1>, <ping値>, <直近m回ping平均>), (<確認datetime 1-2>, <ping値>, <直近m回ping平均>) ... ], 
        <サーバアドレス2> : [(<確認datetime 2-1>, <ping値>, <直近m回ping平均>), (<確認datetime 2-2>, <ping値>, <直近m回ping平均>) ... ], 
            .
            .
            .
    }
    ```
    <確認datetime n-k> は `datetime.datetime`クラスのインスタンスとする. 
    <ping値>はタイムアウト時はNoneそれ以外ではpingの応答時間の整数値とする.  
    ただし, 任意のn, k < l ∈ 自然数において, 
    datetime n-k < datetime n-l となるようにソートする. 

4. 3で得られた連想配列とパラメータNから故障状態を求め, サーバアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <サーバアドレス1> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
        <サーバアドレス2> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
    }
    ```
    <故障期間の始まり>, <故障期間の終わり>, <故障期間>はそれぞれ, 外部設計仕様に従う. 

5. 4で求められた故障状態を表示する.  
    外部設計仕様に従い表示する


6. 3で得られた連想配列とパラメータNから過負荷期間を求め, サーバアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <サーバアドレス1> : [
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
        ],
        <サーバアドレス2> : [
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
            (<過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>), 
        ],
    }
    ```
    <過負荷期間の始まり>, <過負荷期間の終わり>, <過負荷期間>はそれぞれ, 外部設計仕様に従う. 

7. 6で求められた過負荷状態を表示する.  
    外部設計仕様に従い表示する

## テスト

### 設問1に対するテスト 
ここでは故障期間の表示部分のみを確認し, 過負荷状態は確認しない.  
実行は`python3 q3.py <ファイル名>` とする.  
詳細はQ1/document.mdを参照.  
同様な結果を確認しているため, ここでは出力を示さない. 
- [x] test1-0.csv  
- [x] test1-1.csv  
- [x] test1-2.csv  
- [x] test1-3.csv  
- [x] test1-4.csv  
- [x] test1-5.csv  

### 設問2に対するテスト  
ここでは故障期間の表示部分のみを確認し, 過負荷状態は確認しない.   
実行は`python3 q3.py <ファイル名> --N <N>` とする.  
詳細はQ2/document.mdを参照.  
同様な結果を確認しているため, ここでは出力を示さない. 
- [x] N=2の時  
- [x] N=3の時  
- [x] N=4の時  

### 設問3に対するテスト
ここでは, 過負荷期間の表示部分のみ確認し, 故障期間は確認しない. 
- [x] test3-0.csv  
    21 < t < 60でm=1の時のみ過負荷と判定されるサーバが一つ存在するログ
    - [x] m = 1, t = 60 (過負荷あり)
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時31分24秒	2020年10月19日13時33分29秒	2分5秒間
```
    - [x] m = 1, t = 61 (過負荷なし)
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
```
    - [x] m = 2, t = 60 (過負荷なし)
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
```
    - [x] m = 3, t = 21 (過負荷なし)
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
```
- [x] test3-1.csv  
    t = 60においてm=1の時で3回, m=2の時で2回, m=3で1回, m=4で0回, 過負荷と判定されるサーバが一つ存在するログ
    - [x] t=60 m=1 (過負荷3回)  
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時35分24秒	2020年10月19日13時40分29秒	5分5秒間
		2020年10月19日13時42分24秒	2020年10月19日13時44分29秒	2分5秒間
		2020年10月19日13時46分24秒	2020年10月19日13時48分25秒	2分1秒間
```
    - [x] t=60 m=2 (過負荷2回)  
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時43分24秒	2020年10月19日13時44分29秒	1分5秒間
		2020年10月19日13時47分24秒	2020年10月19日13時48分25秒	1分1秒間
```
    - [x] t=60 m=3 (過負荷1回)    
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時48分24秒	2020年10月19日13時48分25秒	1秒間
```
    - [x] t=60 m=4 (過負荷なし)  
```
IP		故障はじめ			故障終わり			期間
IP		過負荷はじめ			過負荷終わり			期間
```
- [x] test3-2.csv  
    内部にtimeoutを含むログ.  
    - [x] t=60 m=1 (過負荷3回)  
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時33分29秒	2020年10月19日13時35分24秒	1分55秒間
		2020年10月19日13時41分29秒	2020年10月19日13時42分24秒	55秒間
		2020年10月19日13時45分29秒	2020年10月19日13時46分24秒	55秒間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時35分24秒	2020年10月19日13時40分29秒	5分5秒間
		2020年10月19日13時42分24秒	2020年10月19日13時44分29秒	2分5秒間
		2020年10月19日13時46分24秒	2020年10月19日13時50分25秒	4分1秒間
```
    - [x] t=60 m=2 (過負荷3回)  
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時33分29秒	2020年10月19日13時35分24秒	1分55秒間
		2020年10月19日13時41分29秒	2020年10月19日13時42分24秒	55秒間
		2020年10月19日13時45分29秒	2020年10月19日13時46分24秒	55秒間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時35分24秒	2020年10月19日13時40分29秒	5分5秒間
		2020年10月19日13時42分24秒	2020年10月19日13時44分29秒	2分5秒間
		2020年10月19日13時46分24秒	2020年10月19日13時49分25秒	3分1秒間
```
    - [x] t=60 m=3 (過負荷3回)    
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時33分29秒	2020年10月19日13時35分24秒	1分55秒間
		2020年10月19日13時41分29秒	2020年10月19日13時42分24秒	55秒間
		2020年10月19日13時45分29秒	2020年10月19日13時46分24秒	55秒間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時35分24秒	2020年10月19日13時40分29秒	5分5秒間
		2020年10月19日13時43分24秒	2020年10月19日13時44分29秒	1分5秒間
		2020年10月19日13時47分24秒	2020年10月19日13時49分25秒	2分1秒間
```
    - [x] t=60 m=4 (過負荷1回)  
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時33分29秒	2020年10月19日13時35分24秒	1分55秒間
		2020年10月19日13時41分29秒	2020年10月19日13時42分24秒	55秒間
		2020年10月19日13時45分29秒	2020年10月19日13時46分24秒	55秒間
IP		過負荷はじめ			過負荷終わり			期間
10.20.30.1/16
		2020年10月19日13時48分24秒	2020年10月19日13時49分25秒	1分1秒間
```
    - [x] t=60 m=5 (過負荷0回)  
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時33分29秒	2020年10月19日13時35分24秒	1分55秒間
		2020年10月19日13時41分29秒	2020年10月19日13時42分24秒	55秒間
		2020年10月19日13時45分29秒	2020年10月19日13時46分24秒	55秒間
IP		過負荷はじめ			過負荷終わり			期間
```
