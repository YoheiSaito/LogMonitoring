# 設問1

## 要求定義

pingがタイムアウトした場合を故障とみなし最初にタイムアウトしたときから次にpingの応答が返るまでを故障期間とする。
監視ログファイルを読み込み、故障状態のサーバアドレスとそのサーバの故障期間を出力する

## 外部設計
 - 入力  
    ログが書き込まれたCSVファイルを入力とする. 
    ```
    IP		故障はじめ			故障終わり			期間
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
    <確認日時>, <サーバアドレス>, <応答結果>
        :
        :
    ```
    ただし, CSVファイルは一行あたりの要素を3つのみとし, それ以外の行は無視する. 

    - 確認日時  
    確認日時はYYYYMMDDhhmmssの形式とする.
    ただし, YYYY=西暦(4桁の半角数字), MM=月(2桁の半角数字), 
    DD=日(2桁の半角数字), hh=時(2桁の半角数字), mm=分(2桁の半角数字), ss=秒(2桁の半角数字)とする. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

    - サーバアドレス  
    サーバアドレスはネットワークプレフックス長付きのIPv4アドレスとする.   

    - 応答結果  
    応答結果はpingの応答時間をミリ秒単位で記載される.  
    ただしタイムアウトの場合は"-"のみが記載される. 
    この形式に合わない入力が存在した場合, 動作を停止する. 

 - 出力  
    以下のフォーマットで故障期間を標準出力に表示する. 

    ```
    <サーバアドレス1>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    <サーバアドレス2>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
        <故障期間の始まり> <故障期間の終わり> <故障期間>
            :
    ```
    ただし, 故障期間の無いサーバアドレスは表示しない. 

    故障期間の始まり, 終わりはそれぞれ 
    "YYYY年MM月DD日hh時mm分ss秒" の形式とする. 
    また 故障期間は"d日h時間m分s秒 間"とする. 
    ただし, d > 0, h ∈ [1, 23], m ∈ [1, 59], s ∈ [1, 59] の整数とし, 
    それぞれが0の時はその数値と後続の単位の表示を行わない. 

    最新の応答結果がタイムアウトの場合は, 故障終わり時間を"継続中"とし, 
    故障期間を表示しない. 
    

 - 環境と実行方法  
    OS : Ubuntu18.04 LTS, python3.8.5 で動作を確認  
    `$python3 q1.py <CSVファイル名>`

##  内部設計仕様

### データフロー

入力されたデータは次のような流れで処理をする.  

1. コマンドライン引数を解析し, 入力ファイル名を決定する.  
2. 決定された入力ファイルを読み込み以下の形式で集計する.  
    ここで, "()"はタプルを, "[]"はリストを意味する. 
    ```
    [
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]),
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
        (CSVの行数(整数), ["<確認日時>", "<サーバアドレス>", "<応答結果>"]), 
                :
    ]
    ```
3. 2で集計されたデータ形式を下記の形式で示された構造に集計し直す.  
    ここで, "()"はタプルを, "[]"はリスト, "{}"は連想配列を意味する. 
    ```
    {
        <サーバアドレス1> : [(<確認datetime 1-1>, <ping値>), (<確認datetime 1-2>, <ping値>) ... ], 
        <サーバアドレス2> : [(<確認datetime 2-1>, <ping値>), (<確認datetime 2-2>, <ping値>) ... ], 
            .
            .
            .
    }
    ```
    <確認datetime n-m> は `datetime.datetime`クラスのインスタンスとする. 
    <ping値>はタイムアウト時はNoneそれ以外ではpingの応答時間の整数値とする.  
    ただし, 任意のn, k < l ∈ 自然数において, 
    datetime n-k < datetime n-l となるようにソートする. 

4. 3で得られた連想配列をもとに故障状態を求め, サーバアドレスをキーとした連想配列にまとめる.  
    ```
    {
        <サーバアドレス1> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
        <サーバアドレス2> : [
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
            (<故障期間の始まり>, <故障期間の終わり>, <故障期間>), 
        ],
    }
    ```
    <故障期間の始まり>, <故障期間の終わり>, <故障期間>はそれぞれ, 外部設計仕様に従う. 

5. 4で求められた故障状態を表示する.  
    外部設計仕様に従い表示する

## テスト

- [x] test1-0.csv  
もっとも基本的な入力である一つのサーバに対する一回の故障について正しく動作するか確認する

実行方法
`$python3 q1.py ../test_file/test1-0.csv`

入力  

```
    20201019133124,10.20.30.1/16,-
    20201019133329,10.20.30.1/16,12
```

出力  
```
    IP              故障はじめ                      故障終わり                      期間
    10.20.30.1/16
                    2020年10月19日13時31分24秒      2020年10月19日13時33分29秒      2分5秒間
```

- [x] test1-1.csv
一つのサーバに対する一回の故障に加え故障しない別サーバを加えについて正しく動作するか確認する

実行方法
`$python3 q1.py ../test_file/test1-1.csv`

入力  
```
20201019133124,10.20.30.1/16,-
20201019133125,10.20.30.2/16,12
20201019133127,10.20.30.3/16,13
20201119133329,10.20.30.1/16,19
20201019133330,10.20.30.2/16,14
20201019133332,10.20.30.3/16,21
```

出力  
10.20.30.1/16のみが表示される. 
```
    IP              故障はじめ                      故障終わり                      期間
    10.20.30.1/16
                    2020年10月19日13時31分24秒      2020年11月19日13時33分29秒      31日2分5秒間
```

- [x] test1-2.csv 
3回のpingを行ったときに1度タイムアウトする状況に対しての全パターンについて正しく動作するか確認する. 

実行方法
`$python3 q1.py ../test_file/test1-2.csv`

入力
```
20201019133124,10.20.30.1/16,2
20201019133125,10.20.30.2/16,-
20201019133224,10.20.30.1/16,21
20201019133329,10.20.30.1/16,20
20201019133126,10.20.30.3/16,15
20201019133225,10.20.30.2/16,14
20201019133127,10.20.30.4/16,200
20201019133227,10.20.30.4/16,129
20201019133226,10.20.30.3/16,-
20201019133330,10.20.30.2/16,12
20201019133332,10.20.30.4/16,-
20201029133331,10.20.30.3/16,9
```

出力 (IPは順不同)   
10.20.30.2, 10.20.30.3, 10.20.30.4が表示される. 
10.20.30.4は最終ログが故障中のため, 故障終わりが継続中となる. 
```

IP              故障はじめ                      故障終わり                      期間
10.20.30.2/16
    2020年10月19日13時31分25秒      2020年10月19日13時32分25秒      1分間
10.20.30.3/16
    2020年10月19日13時32分26秒      2020年10月29日13時33分31秒      10日1分5秒間
10.20.30.4/16
    2020年10月19日13時33分32秒      継続中
```


- [x] test1-3.csv 
連続で2度タイムアウトする場合について正しく動作するか確認する. 

実行方法
`$python3 q1.py ../test_file/test1-3.csv`

入力
```
20201019133120,10.20.30.1/16,21
20201019133124,10.20.30.2/16,-
20201019133125,10.20.30.3/16,15
20201019133126,10.20.30.1/16,-
20201019133224,10.20.30.2/16,-
20201019133225,10.20.30.3/16,-
20201019133226,10.20.30.1/16,-
20201019133329,10.20.30.2/16,48
20201019133330,10.20.30.3/16,-
20201019133331,10.20.30.1/16,18
```

出力 (IPは順不同)  
10.20.30.1, 10.20.30.2, 10.20.30.3が表示される. 
10.20.30.3は最終ログが故障中のため, 故障終わりが継続中となる. 
```

IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時31分26秒	2020年10月19日13時33分31秒	2分5秒間
10.20.30.2/16
		2020年10月19日13時31分24秒	2020年10月19日13時33分29秒	2分5秒間
10.20.30.3/16
		2020年10月19日13時32分25秒	継続中	
```


- [x] test1-4.csv 
連続で3回タイムアウトする場合について正しく動作するか確認する. 

実行方法
`$python3 q1.py ../test_file/test1-4.csv`

入力
```
20201019133126,10.20.30.1/16,35
20201019133224,10.20.30.2/16,-
20201019133225,10.20.30.3/16,28
20201019133226,10.20.30.1/16,-
20201019133329,10.20.30.2/16,-
20201019133330,10.20.30.3/16,-
20201019133331,10.20.30.1/16,-
20201019133424,10.20.30.2/16,-
20201019133425,10.20.30.3/16,-
20201019133426,10.20.30.1/16,-
20201019133524,10.20.30.2/16,18
20201019133525,10.20.30.3/16,-
20201019133526,10.20.30.1/16,20
```

出力 (IPは順不同)  
10.20.30.1, 10.20.30.2, 10.20.30.3が表示される. 
10.20.30.3は最終ログが故障中のため, 故障終わりが継続中となる. 
```
IP		故障はじめ			故障終わり			期間
10.20.30.1/16
		2020年10月19日13時32分26秒	2020年10月19日13時35分26秒	3分間
10.20.30.2/16
		2020年10月19日13時32分24秒	2020年10月19日13時35分24秒	3分間
10.20.30.3/16
		2020年10月19日13時33分30秒	継続中	
```


- [x] test1-5.csv 
2度以上故障する場合について正しく動作するか確認する. 

実行方法
`$python3 q1.py ../test_file/test1-5.csv`

入力
```
20201019133134,192.168.1.1/24,-
20201019133135,192.168.1.2/24,14
20201019133136,192.168.1.1/24,10
20201019133137,192.168.1.2/24,-
20201019133138,192.168.1.1/24,-
20201019133139,192.168.1.2/24,13
20201019133140,192.168.1.1/24,10
20201019133141,192.168.1.2/24,-
20201019133142,192.168.1.1/24,-
20201019133143,192.168.1.2/24,11
```

出力 (IPは順不同)  
192.168.1.1, 192.168.1.2が表示される. 
192.168.1.1は3回, 
192.168.1.2は2回故障している.  
192.168.1.1は最終ログが故障中のため, 最後の故障終わりが継続中となる. 
```
IP		故障はじめ			故障終わり			期間
192.168.1.1/24
		2020年10月19日13時31分34秒	2020年10月19日13時31分36秒	2秒間
		2020年10月19日13時31分38秒	2020年10月19日13時31分40秒	2秒間
		2020年10月19日13時31分42秒	継続中	
192.168.1.2/24
		2020年10月19日13時31分37秒	2020年10月19日13時31分39秒	2秒間
		2020年10月19日13時31分41秒	2020年10月19日13時31分43秒	2秒間
```


